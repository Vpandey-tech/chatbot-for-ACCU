import os
import logging
from typing import List, Dict, Any, Optional
import random
import time

# Configure logging
logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

class MechanicalEngineeringLLM:
    """Handles interactions with the language model for mechanical engineering domain."""
    
    def __init__(self, model_name: str = "TinyLlama/TinyLlama-1.1B-Chat-v1.0"):
        """
        Initialize the model handler.
        
        Args:
            model_name: The name of the Hugging Face model to use
        """
        self.model_name = model_name
        self.max_length = 1024
        self.max_new_tokens = 512
        self.temperature = 0.7
        
        # Pre-defined responses based on domain
        self.domain_responses = {
            "general": [
                "In mechanical engineering, this question involves several fundamental principles. The main considerations include material properties, design constraints, and engineering standards. For optimal solutions, you'll need to account for safety factors and performance requirements.",
                "This is a common mechanical engineering problem. I would approach it by first identifying the boundary conditions, then applying the relevant mechanical principles like Newton's laws or conservation of energy. The solution typically requires iterative calculations to optimize the design."
            ],
            "thermodynamics": [
                "From a thermodynamic perspective, this involves analyzing energy transfers and transformations. The first law of thermodynamics (conservation of energy) tells us that energy cannot be created or destroyed, only transferred or converted. In this case, we need to consider the heat transfer mechanisms: conduction, convection, and radiation.",
                "When analyzing this thermodynamic system, we need to consider entropy production and energy efficiency. The most efficient processes are reversible, but real-world applications always involve some irreversibility leading to entropy generation. The second law of thermodynamics sets theoretical limits on efficiency."
            ],
            "fluid_mechanics": [
                "In fluid mechanics, this question relates to the behavior of fluids in motion or at rest. We can apply Bernoulli's equation to understand how pressure, velocity, and elevation interact in fluid flow. For viscous fluids, we may need to consider the Navier-Stokes equations for more accurate modeling.",
                "This fluid mechanics problem requires analyzing both hydrostatic and hydrodynamic conditions. Reynolds number helps determine whether the flow is laminar or turbulent. For pipe systems, we also need to account for major and minor losses due to friction and fittings."
            ],
            "materials": [
                "Material selection for this application depends on several factors: mechanical properties (strength, ductility, toughness), environmental conditions (temperature, corrosion), and manufacturing considerations. Steel alloys offer good strength-to-weight ratios, while polymers provide corrosion resistance but lower mechanical properties.",
                "The material behavior you're describing relates to its stress-strain relationship. Under elastic deformation, materials follow Hooke's Law where stress is proportional to strain. Beyond the elastic limit, plastic deformation occurs, leading to permanent changes in the material structure."
            ],
            "machine_design": [
                "For this machine design problem, we need to consider the kinematics and dynamics of the mechanism. The design should account for static and dynamic loading conditions, fatigue life, and manufacturability. I recommend using factor of safety calculations based on the maximum stress theory or distortion energy theory.",
                "In designing this mechanical system, gear selection is critical. Spur gears offer simplicity and efficiency for parallel shafts, while helical gears provide smoother operation but introduce axial forces. Bevel gears are appropriate for intersecting shafts, and worm gears provide high reduction ratios."
            ],
            "manufacturing": [
                "This manufacturing process requires careful consideration of material properties, tooling, and process parameters. For precision components, CNC machining offers tight tolerances but at higher cost. Investment casting might be suitable for complex geometries, while injection molding is economical for high-volume polymer parts.",
                "Optimizing this manufacturing process involves balancing quality, cost, and production rate. Consider implementing statistical process control (SPC) to monitor key variables. Modern approaches like Design for Manufacturing (DFM) can help identify and eliminate potential manufacturing issues early in the design phase."
            ],
            "dynamics": [
                "This dynamics problem involves analyzing the motion of mechanical systems. We can use Newton's second law (F=ma) for particle dynamics or principles like work-energy and impulse-momentum for more complex systems. For rotating bodies, we need to consider moments of inertia and angular momentum.",
                "Vibration analysis for this system requires identifying natural frequencies and mode shapes. Resonance occurs when the forcing frequency matches a natural frequency, potentially causing excessive amplitudes. Damping mechanisms can help control unwanted vibrations and prevent structural damage."
            ],
            "controls": [
                "This control system can be analyzed using both time-domain and frequency-domain approaches. For stability analysis, we can examine the system's poles or apply the Routh-Hurwitz criterion. PID controllers offer a robust solution with tunable proportional, integral, and derivative terms to achieve desired performance metrics.",
                "Designing a control system for this mechanical application requires modeling the plant dynamics, selecting appropriate sensors and actuators, and implementing a control algorithm. Feedback control provides robustness against disturbances and parameter variations, while feedforward control can improve response to reference inputs."
            ]
        }
        
        logger.info(f"Initialized simulated model: {model_name}")
    
    def format_prompt(self, user_message: str, context: List[Dict[str, str]], specialized_prompt: str) -> str:
        """
        Format the prompt for the language model.
        
        Args:
            user_message: The user's message
            context: List of previous messages in the conversation
            specialized_prompt: Domain-specific instruction
            
        Returns:
            Formatted prompt string
        """
        # Basic prompt structure
        system_prompt = f"""You are MechAssist, a mechanical engineering assistant. You help solve problems related to mechanical engineering concepts and calculations.
{specialized_prompt}
Respond with accurate, technical information. If you're unsure, indicate your uncertainty rather than providing incorrect information.
Use proper units and cite fundamental principles when appropriate."""
        
        # Format conversation context
        formatted_context = ""
        if context:
            for message in context:
                role = message.get("role", "user")
                content = message.get("content", "")
                if role == "user":
                    formatted_context += f"User: {content}\n"
                else:
                    formatted_context += f"MechAssist: {content}\n"
        
        # Combine all parts into a single prompt
        prompt = f"{system_prompt}\n\n"
        if formatted_context:
            prompt += f"Previous conversation:\n{formatted_context}\n\n"
            
        prompt += f"User: {user_message}\nMechAssist:"
        
        return prompt
    
    def generate_response(self, 
                        user_message: str, 
                        context: Optional[List[Dict[str, str]]] = None,
                        specialized_prompt: str = "") -> str:
        """
        Generate a response to the user's message.
        
        Args:
            user_message: The user's message
            context: Optional list of previous messages
            specialized_prompt: Domain-specific instruction
            
        Returns:
            The model's response
        """
        if context is None:
            context = []
        
        try:
            # Format the prompt
            prompt = self.format_prompt(user_message, context, specialized_prompt)
            
            # Log the prompt
            logger.debug(f"Generating response for prompt: {prompt[:100]}...")
            
            # Simulate processing time
            time.sleep(0.5)
            
            # Determine which domain to use
            domain = "general"
            for key in self.domain_responses.keys():
                if key in specialized_prompt.lower():
                    domain = key
                    break
            
            # Domain-specific expert responses
            # These are more detailed, technical responses for common questions in each domain
            expert_responses = {
                "thermodynamics": {
                    "conduction": "Conduction and convection are two primary heat transfer mechanisms with fundamental differences:\n\n<b>Conduction:</b> This is heat transfer through direct molecular interaction without bulk movement. It occurs in solids or stationary fluids where energy transfers from higher-energy particles to adjacent lower-energy particles. The rate is governed by Fourier's Law: q = -k∇T, where k is thermal conductivity (W/m·K).\n\nKey characteristics:\n- Requires physical contact between materials\n- Dominant in solids (especially metals with free electrons)\n- No bulk material movement\n- Examples: Heat traveling through a metal pot, heat sink conducting heat away from CPU\n\n<b>Convection:</b> This is heat transfer through fluid motion, where energy transfers between a surface and moving fluid. It's described by Newton's Law of Cooling: q = hA(Ts-T∞), where h is the convection coefficient (W/m²·K).\n\nKey characteristics:\n- Requires fluid motion (liquid or gas)\n- Can be natural (buoyancy-driven) or forced (pump/fan-driven)\n- Enhanced by greater temperature differences and surface area\n- Examples: Hot air rising from radiator, water boiling in a pot\n\nThe fundamental difference is that conduction operates through stationary molecular interaction, while convection relies on fluid movement to transport thermal energy.",
                    
                    "heat transfer": "Heat transfer in mechanical engineering occurs through three fundamental mechanisms:\n\n<b>1. Conduction:</b> Direct heat transfer through matter via molecular vibrations and free electron movement, governed by Fourier's Law: q″ = -k∇T. Thermal conductivity (k) varies by material, with metals having high values (copper: ~400 W/m·K) and insulators having low values (fiberglass: ~0.04 W/m·K).\n\n<b>2. Convection:</b> Heat transfer through fluid movement, described by Newton's Law of Cooling: q″ = h(Ts-T∞). The convection coefficient (h) varies significantly depending on flow conditions (natural: 5-25 W/m²·K; forced air: 25-250 W/m²·K; water: 500-10,000 W/m²·K).\n\n<b>3. Radiation:</b> Electromagnetic heat transfer requiring no medium, following the Stefan-Boltzmann Law: q″ = εσ(Ts⁴-Tsur⁴), where ε is emissivity (0-1) and σ is the Stefan-Boltzmann constant (5.67×10⁻⁸ W/m²·K⁴).\n\nIn practical engineering applications, these mechanisms often occur simultaneously. For example, in heat exchangers, conduction occurs through tube walls while convection dominates fluid-to-wall heat transfer.",
                    
                    "carnot cycle": "The Carnot cycle is the theoretical ideal thermodynamic cycle that establishes the maximum possible efficiency for heat engines operating between two temperature reservoirs.\n\n<b>The cycle consists of four reversible processes:</b>\n1. Isothermal expansion (heat addition at TH)\n2. Adiabatic expansion (temperature drops from TH to TC)\n3. Isothermal compression (heat rejection at TC)\n4. Adiabatic compression (temperature rises from TC to TH)\n\n<b>The thermal efficiency is calculated as:</b>\nη = 1 - TC/TH\n\nWhere TC is the cold reservoir temperature and TH is the hot reservoir temperature (both in Kelvin).\n\nThis equation represents the theoretical maximum efficiency possible for any heat engine. Real engines always have lower efficiencies due to irreversibilities such as friction, heat loss, and fluid flow losses.\n\n<b>Key implications:</b>\n- Higher temperature differentials yield higher maximum efficiencies\n- Even perfect heat engines cannot convert all heat to work (Second Law of Thermodynamics)\n- The Carnot efficiency serves as a benchmark for evaluating real thermodynamic cycles\n\nFor example, modern power plants operate at efficiencies of 35-60% compared to their Carnot efficiencies of 60-70%."
                },
                
                "fluid_mechanics": {
                    "bernoulli": "Bernoulli's equation is a fundamental principle in fluid mechanics that relates pressure, velocity, and elevation in a flowing fluid. The principle states that for an inviscid, incompressible fluid in steady flow, the total mechanical energy remains constant along a streamline.\n\n<b>The equation is expressed as:</b>\nP₁ + ½ρv₁² + ρgh₁ = P₂ + ½ρv₂² + ρgh₂\n\nWhere:\n- P = pressure (Pa)\n- ρ = fluid density (kg/m³)\n- v = fluid velocity (m/s)\n- g = gravitational acceleration (9.81 m/s²)\n- h = height/elevation (m)\n\n<b>Key applications include:</b>\n\n1. <b>Venturi meters:</b> Flow measurement devices that use a constriction to create a pressure difference proportional to the flow rate.\n\n2. <b>Airfoil design:</b> The pressure difference between upper and lower surfaces of an airfoil creates lift according to Bernoulli's principle.\n\n3. <b>Pitot tubes:</b> Used to measure fluid flow velocity by comparing stagnation pressure to static pressure.\n\n<b>Limitations:</b> The equation assumes steady, inviscid, incompressible flow along a streamline. For real fluids with viscosity, additional terms or corrections are needed to account for energy losses due to friction.",
                    
                    "reynolds number": "The Reynolds number (Re) is a dimensionless parameter that characterizes fluid flow behavior, particularly the transition between laminar and turbulent regimes.\n\n<b>It is defined as:</b>\nRe = ρvL/μ = vL/ν\n\nWhere:\n- ρ = fluid density (kg/m³)\n- v = flow velocity (m/s)\n- L = characteristic length (m) - e.g., pipe diameter, chord length\n- μ = dynamic viscosity (kg/m·s)\n- ν = kinematic viscosity (m²/s)\n\n<b>Flow regimes are generally characterized as:</b>\n- Re < 2300: Laminar flow (smooth, orderly layers)\n- 2300 < Re < 4000: Transitional flow (unstable, mixed characteristics)\n- Re > 4000: Turbulent flow (chaotic, with eddies and vortices)\n\n<b>Engineering significance:</b>\n\n1. <b>Pipe flow:</b> Determines friction factor for pressure drop calculations. In laminar flow, f = 64/Re; in turbulent flow, more complex relations like the Colebrook equation apply.\n\n2. <b>External flow:</b> Affects drag coefficients and heat transfer rates around objects.\n\n3. <b>Scaling:</b> Enables the use of scale models in wind tunnels and hydrodynamic testing by matching Reynolds numbers between model and prototype.\n\nPractical examples include calculating pressure drops in piping systems, designing efficient heat exchangers, and optimizing aerodynamic shapes in vehicles and aircraft."
                },
                
                "materials": {
                    "stress strain": "The stress-strain relationship is fundamental to understanding material behavior under load. It characterizes how materials deform and ultimately fail.\n\n<b>Key concepts:</b>\n\n1. <b>Stress (σ):</b> Force per unit area (F/A), measured in Pa or N/m². Types include:\n   - Tensile/compressive stress (normal to the area)\n   - Shear stress (parallel to the area)\n\n2. <b>Strain (ε):</b> Dimensionless measure of deformation\n   - Linear strain: ΔL/L₀ (change in length per original length)\n   - Shear strain: angular deformation in radians\n\n<b>Stress-strain curve regions:</b>\n\na) <b>Elastic region:</b>\n   - Linear portion following Hooke's Law: σ = Eε\n   - E is Young's modulus or elastic modulus (GPa)\n   - Deformation is reversible\n   - Proportional limit marks the end of linear elasticity\n\nb) <b>Plastic region:</b>\n   - Permanent deformation occurs beyond yield point\n   - Material continues to strengthen due to strain hardening\n   - Ultimate tensile strength (UTS) is the maximum stress value\n\nc) <b>Necking and failure:</b>\n   - Cross-sectional area decreases (necking)\n   - Actual stress increases while engineering stress appears to decrease\n   - Fracture occurs at breaking point\n\n<b>Material properties derived from the curve:</b>\n- Elastic modulus (E): slope of elastic region (stiffness)\n- Yield strength (σy): stress at yield point\n- Ultimate tensile strength (σUTS): maximum stress value\n- Ductility: strain at failure (elongation percentage)\n- Toughness: area under the entire curve (energy absorption capacity)\n- Resilience: area under elastic portion (recoverable energy)\n\nThese properties are crucial for material selection in mechanical design to ensure components can withstand anticipated loads without failure.",
                    
                    "metal properties": "Metals are essential engineering materials characterized by specific properties that determine their application suitability.\n\n<b>1. Mechanical Properties:</b>\n- <b>Strength:</b> Resistance to deformation under load\n  - Tensile strength: 200-2000 MPa (steel), 70-700 MPa (aluminum alloys)\n  - Yield strength: Point at which plastic deformation begins\n- <b>Hardness:</b> Resistance to indentation or scratching\n  - Measured on scales like Brinell (BHN), Rockwell (HRB/HRC), or Vickers (HV)\n- <b>Ductility:</b> Ability to deform without fracture (% elongation)\n  - High in copper, aluminum (~40-50%), lower in hardened steels (5-15%)\n- <b>Toughness:</b> Energy absorption before fracture\n  - Critical for impact and fatigue resistance\n\n<b>2. Physical Properties:</b>\n- <b>Density:</b> Mass per unit volume\n  - Steel: ~7.8 g/cm³, Aluminum: ~2.7 g/cm³, Titanium: ~4.5 g/cm³\n- <b>Thermal conductivity:</b> Heat transfer capacity\n  - Copper: ~400 W/m·K, Aluminum: ~237 W/m·K, Steel: ~50 W/m·K\n- <b>Thermal expansion:</b> Dimensional change with temperature\n  - Critical for applications with temperature fluctuations\n- <b>Melting point:</b> Temperature of solid-to-liquid transition\n  - Tungsten: 3422°C, Steel: ~1370-1530°C, Aluminum: ~660°C\n\n<b>3. Manufacturing considerations:</b>\n- <b>Machinability:</b> Ease of cutting (higher in free-cutting steels, brass)\n- <b>Weldability:</b> Ability to be joined by welding (excellent in mild steel)\n- <b>Castability:</b> Suitability for casting processes (superior in cast irons, aluminum)\n- <b>Formability:</b> Ability to be formed without cracking (good in annealed copper, aluminum)\n\n<b>4. Environmental response:</b>\n- <b>Corrosion resistance:</b> Ability to withstand chemical attack\n  - Excellent in titanium, stainless steels (high chromium content)\n  - Poor in carbon steels without protection\n- <b>Oxidation resistance:</b> Resistance to high-temperature degradation\n\nMaterial selection involves balancing these properties against requirements, costs, and availability for specific engineering applications.",
                },
                
                "machine_design": {
                    "gear systems": "Gear systems are fundamental mechanical components that transmit rotary motion and power while providing mechanical advantage. Their design involves careful consideration of various types, geometries, and applications.\n\n<b>Major gear types:</b>\n\n1. <b>Spur gears:</b>\n   - Simplest type with straight teeth parallel to rotation axis\n   - High efficiency (98-99%) but can be noisy at high speeds\n   - Used in power transmission with parallel shafts\n   - No axial thrust loads\n\n2. <b>Helical gears:</b>\n   - Teeth cut at an angle to the face of gear\n   - Smoother, quieter operation than spur gears\n   - Generates axial thrust requiring appropriate bearings\n   - Efficiency: 96-98%\n   - Used in automotive transmissions, higher-speed applications\n\n3. <b>Bevel gears:</b>\n   - Conical shape with teeth for intersecting shafts (typically 90°)\n   - Types include straight, spiral, and zerol bevel\n   - Efficiency: 94-98%\n   - Used in differential drives, right-angle drives\n\n4. <b>Worm gears:</b>\n   - Non-intersecting, perpendicular shafts\n   - High reduction ratios (20:1 to 300:1) in single stage\n   - Self-locking capability (prevents reverse motion)\n   - Lower efficiency (70-90%) due to sliding action\n   - Used where high reduction and compact size are needed\n\n<b>Key design parameters:</b>\n- Module (m): tooth size parameter (pitch diameter/number of teeth)\n- Pressure angle: typically 14.5°, 20°, or 25° (higher angles = stronger teeth)\n- Number of teeth: affects size, ratio, and susceptibility to interference\n- Face width: affects load capacity and beam strength\n- Material: typically heat-treated steel, bronze, or engineered plastics\n\n<b>Common failure modes:</b>\n- Tooth bending fatigue\n- Surface pitting and wear\n- Scoring due to lubricant breakdown\n- Plastic deformation under excessive loads\n\nModern gear design involves computational methods to optimize tooth profiles, minimize noise, maximize strength, and extend service life under specific operating conditions.",
                    
                    "bearings": "Bearings are mechanical components that constrain relative motion while reducing friction between moving parts. Proper bearing selection is critical for machine reliability, efficiency, and service life.\n\n<b>Main bearing types:</b>\n\n1. <b>Rolling element bearings:</b>\n   - <b>Ball bearings:</b> Use spherical balls as rolling elements\n     - Good for moderate loads, high speeds\n     - Handle both radial and axial loads\n     - Types: deep groove, angular contact, self-aligning\n   - <b>Roller bearings:</b> Use cylindrical, tapered, spherical, or needle rollers\n     - Higher load capacity than ball bearings\n     - Cylindrical: high radial loads, little axial capacity\n     - Tapered: combined radial and axial loads\n     - Spherical: accommodate misalignment\n     - Needle: high capacity in limited radial space\n\n2. <b>Plain bearings (bushings):</b>\n   - Simple sliding surface without rolling elements\n   - Materials: bronze, babbitt, PTFE, engineered polymers\n   - Advantages: silent operation, shock absorption, compact\n   - Require proper lubrication to prevent wear\n\n<b>Selection criteria:</b>\n1. <b>Load characteristics:</b>\n   - Magnitude, direction (radial, axial, combined)\n   - Dynamic vs. static loading\n   - Shock or impact conditions\n\n2. <b>Motion parameters:</b>\n   - Speed (RPM)\n   - Continuous vs. intermittent operation\n   - Oscillating vs. rotating\n\n3. <b>Environmental factors:</b>\n   - Temperature range\n   - Contamination exposure\n   - Moisture/corrosive conditions\n\n4. <b>Precision requirements:</b>\n   - Runout tolerances\n   - Stiffness needs\n   - Noise limitations\n\n<b>Lubrication:</b> Critical for bearing performance and longevity\n- Oil: Better cooling, good for high speeds/loads\n- Grease: Simpler sealing, less maintenance\n- Solid: Extreme temperature or vacuum conditions\n\n<b>Life calculation:</b> Based on L10 life (time at which 10% of bearings will fail)\nL10 = (C/P)ᵏ × 10⁶ revolutions\nWhere C = dynamic load rating, P = equivalent dynamic load, k = 3 for ball bearings, 10/3 for roller bearings\n\nBearing selection is a critical aspect of mechanical design that significantly impacts system performance, maintenance requirements, and operational costs."
                },
                
                "manufacturing": {
                    "3d printing": "3D printing, or additive manufacturing (AM), encompasses various processes that build three-dimensional objects layer-by-layer from digital models. This technology has revolutionized manufacturing with its flexibility and ability to create complex geometries.\n\n<b>Major 3D printing technologies in mechanical engineering:</b>\n\n1. <b>Fused Deposition Modeling (FDM):</b>\n   - Process: Thermoplastic filament extruded through heated nozzle\n   - Materials: PLA, ABS, PETG, Nylon, TPU, composite filaments\n   - Advantages: Low cost, wide material selection, simple post-processing\n   - Limitations: Lower dimensional accuracy (±0.1-0.5mm), visible layer lines\n   - Mechanical properties: Anisotropic, typical tensile strength 30-100 MPa\n   - Applications: Prototypes, fixtures, non-critical components\n\n2. <b>Stereolithography (SLA)/Digital Light Processing (DLP):</b>\n   - Process: Photopolymer resin cured by UV light/projector\n   - Materials: Various photopolymer resins (standard, tough, flexible, castable)\n   - Advantages: High detail resolution (25-100 microns), smooth surface finish\n   - Limitations: Brittle materials, UV degradation, more expensive than FDM\n   - Applications: Detailed prototypes, patterns for casting, dental/medical models\n\n3. <b>Selective Laser Sintering/Melting (SLS/SLM):</b>\n   - Process: Powder bed fusion using laser to sinter/melt material\n   - Materials: SLS: Nylon, TPU; SLM: Aluminum, titanium, steel, Inconel\n   - Advantages: Excellent mechanical properties, no support structures (SLS)\n   - Limitations: Expensive equipment, powder handling challenges\n   - Mechanical properties: Nearly isotropic, comparable to traditional manufacturing\n   - Applications: Functional parts, aerospace components, custom tooling\n\n<b>Design considerations for manufacturability:</b>\n- Minimum wall thickness (technology-dependent: FDM ~0.8mm, SLA ~0.5mm, SLM ~0.2mm)\n- Support structures (orientation affects surface finish and strength)\n- Build orientation (affects strength, resolution, and build time)\n- Post-processing requirements (support removal, curing, heat treatment)\n\n<b>Mechanical engineering applications:</b>\n- Rapid prototyping for design validation\n- Custom tooling and fixtures with optimized geometries\n- Low-volume production of end-use parts\n- Topology-optimized components with reduced weight\n- Complex assemblies consolidated into single parts\n\nModern mechanical engineering increasingly integrates 3D printing into traditional manufacturing workflows to capitalize on its unique capabilities while complementing conventional processes.",
                    
                    "cnc machining": "CNC (Computer Numerical Control) machining is a subtractive manufacturing process that uses computer-controlled cutting tools to remove material from a workpiece to produce precise components. It's a foundational manufacturing technology in mechanical engineering.\n\n<b>Major CNC processes:</b>\n\n1. <b>CNC Milling:</b>\n   - Uses rotating multi-point cutting tools\n   - Capabilities: Slots, pockets, contours, threads, 3D surfaces\n   - Types: 3-axis (standard), 4/5-axis (complex geometries)\n   - Typical tolerances: ±0.025-0.076mm (0.001-0.003\")\n   - Materials: Metals, plastics, composites, wood\n\n2. <b>CNC Turning/Lathe:</b>\n   - Workpiece rotates against stationary cutting tool\n   - Capabilities: Cylindrical features, tapers, threads, grooves\n   - Typical tolerances: ±0.013-0.05mm (0.0005-0.002\")\n   - Live tooling lathes combine turning and milling capabilities\n\n3. <b>CNC Grinding:</b>\n   - Abrasive wheel for high-precision finishing\n   - Capabilities: Extremely tight tolerances and surface finishes\n   - Typical tolerances: ±0.0025-0.013mm (0.0001-0.0005\")\n   - Often used for hardened materials and precision components\n\n<b>Critical process parameters:</b>\n\n1. <b>Cutting speed:</b> Surface speed at tool-workpiece interface (m/min or ft/min)\n   - Depends on material, tool material, cooling method\n   - Example ranges: Aluminum (300-1000 m/min), Steel (30-200 m/min)\n\n2. <b>Feed rate:</b> Tool advancement per revolution/minute\n   - Affects surface finish, tool life, productivity\n   - Typically 0.05-0.5 mm/rev for turning, 0.01-0.1 mm/tooth for milling\n\n3. <b>Depth of cut:</b> Material thickness removed in one pass\n   - Roughing: Deeper cuts (1-5mm+)\n   - Finishing: Shallow cuts (0.1-0.5mm)\n\n4. <b>Tool selection:</b>\n   - Geometry: Optimized for material and operation\n   - Material: HSS, carbide, ceramics, CBN, diamond\n   - Coatings: TiN, TiCN, TiAlN, diamond for improved wear resistance\n\n<b>Design considerations for CNC machining:</b>\n- Internal corners always have radius equal to cutting tool radius\n- Avoid deep pockets with small corner radii (depth:width ratio <4:1 ideal)\n- Consider tool accessibility and fixturing requirements\n- Standard thread sizes and hole dimensions reduce tooling costs\n- Specify appropriate surface finish requirements (Ra values)\n\n<b>Advantages in mechanical engineering:</b>\n- High precision and repeatability\n- Excellent for prototyping and low-to-medium volume production\n- Wide material compatibility\n- Complex geometries possible with modern multi-axis machines\n- Established process with predictable outcomes\n\nCNC machining remains a critical manufacturing process for precision mechanical components despite advances in additive manufacturing.",
                },
                
                "dynamics": {
                    "vibration": "Vibration in mechanical systems is the oscillatory motion of an object or structure about an equilibrium position. Understanding and controlling vibration is critical for machine performance, reliability, and safety.\n\n<b>Fundamental concepts:</b>\n\n1. <b>Single degree of freedom (SDOF) system:</b>\n   - Characterized by mass (m), spring stiffness (k), and damping coefficient (c)\n   - Natural frequency: ωn = √(k/m) [rad/s] or fn = ωn/2π [Hz]\n   - Damping ratio: ζ = c/2√(km) (underdamped: ζ<1, critically damped: ζ=1, overdamped: ζ>1)\n   - Time response: x(t) = Xe^(-ζωnt)sin(ωd t + φ), where ωd = ωn√(1-ζ²)\n\n2. <b>Multiple degree of freedom (MDOF) systems:</b>\n   - Characterized by mass, stiffness, and damping matrices\n   - Multiple natural frequencies and mode shapes\n   - Each mode represents a distinct pattern of motion\n\n<b>Vibration analysis methods:</b>\n\n1. <b>Time domain analysis:</b>\n   - Direct integration of equations of motion\n   - Transient response to initial conditions and forcing functions\n   - Time history data analysis (peak values, RMS, crest factor)\n\n2. <b>Frequency domain analysis:</b>\n   - Fast Fourier Transform (FFT) converts time signals to frequency spectra\n   - Frequency Response Functions (FRFs) show system behavior across frequencies\n   - Power Spectral Density (PSD) for random vibration analysis\n\n<b>Common vibration issues in machinery:</b>\n\n1. <b>Resonance:</b>\n   - Occurs when forcing frequency matches natural frequency\n   - Results in amplified response and potential failure\n   - Critical speeds in rotating machinery often correspond to resonance conditions\n\n2. <b>Unbalance:</b>\n   - Primary source of vibration in rotating equipment\n   - Characterized by 1× running speed frequency component\n   - Corrected through balancing procedures (single or multi-plane)\n\n3. <b>Misalignment:</b>\n   - Typically produces 1× and 2× running speed components\n   - Angular misalignment vs. parallel misalignment symptoms differ\n\n4. <b>Bearing defects:</b>\n   - Produce characteristic frequencies based on bearing geometry\n   - Inner race, outer race, ball, and cage defect frequencies\n\n<b>Vibration control methods:</b>\n\n1. <b>Isolation:</b> Preventing transmission of vibration (rubber mounts, springs)\n   - Transmissibility ratio: TR = 1/√[(1-(f/fn)²)² + (2ζf/fn)²]\n   - Effective isolation requires f/fn > √2\n\n2. <b>Damping:</b> Dissipating vibration energy (viscoelastic materials, fluid dampers)\n\n3. <b>Dynamic absorbers:</b> Secondary mass-spring systems tuned to problematic frequencies\n\n4. <b>Structural modifications:</b> Changing mass or stiffness to alter natural frequencies\n\nProper vibration analysis and control are essential for mechanical design, particularly for high-speed machinery, precision equipment, and structures subject to dynamic loading.",
                    
                    "control systems": "Control systems are essential in mechanical engineering for regulating dynamic system behavior to achieve desired performance. They integrate sensors, controllers, and actuators to manipulate system variables automatically.\n\n<b>Fundamental concepts:</b>\n\n1. <b>Open-loop vs. closed-loop control:</b>\n   - Open-loop: No feedback, output doesn't affect control action\n   - Closed-loop: Uses feedback to compare actual to desired output\n   - Feedback provides robustness against disturbances and model uncertainties\n\n2. <b>System representation:</b>\n   - Transfer functions (Laplace domain): G(s) = Output(s)/Input(s)\n   - State-space models: ẋ = Ax + Bu, y = Cx + Du\n   - Block diagrams: Graphical representation of system components\n\n3. <b>System characteristics:</b>\n   - Stability: Bounded input produces bounded output\n   - Steady-state error: Difference between reference and final output\n   - Transient response: Overshoot, rise time, settling time\n   - Bandwidth: Range of frequencies the system can respond to\n\n<b>Controller types:</b>\n\n1. <b>PID (Proportional-Integral-Derivative):</b>\n   - Most common industrial controller\n   - u(t) = Kp·e(t) + Ki∫e(t)dt + Kd·de(t)/dt\n   - Proportional term: Reduces rise time, affects stability\n   - Integral term: Eliminates steady-state error\n   - Derivative term: Improves stability, reduces overshoot\n   - Tuning methods: Ziegler-Nichols, Cohen-Coon, optimization techniques\n\n2. <b>Advanced controllers:</b>\n   - State feedback: u = -Kx (requires state estimation if not all states measurable)\n   - Model predictive control (MPC): Optimizes future behavior using system model\n   - Adaptive control: Parameters adjust to changing system conditions\n   - Robust control: Maintains performance despite uncertainties\n\n<b>Mechanical system applications:</b>\n\n1. <b>Motion control:</b>\n   - Position, velocity, acceleration regulation\n   - Servo drives, CNC machines, robotics\n   - Requires consideration of friction, backlash, and flexibility\n\n2. <b>Process control:</b>\n   - Temperature, pressure, flow, level regulation\n   - HVAC systems, chemical processes, fluid systems\n   - Often involves significant time delays and nonlinearities\n\n3. <b>Vibration control:</b>\n   - Active damping of structural vibrations\n   - Noise cancellation\n   - Vehicle suspension systems\n\n<b>Implementation considerations:</b>\n\n1. <b>Actuator selection:</b>\n   - Electric (motors, solenoids)\n   - Hydraulic (cylinders, motors)\n   - Pneumatic (cylinders, valves)\n   - Selection based on force/torque, speed, precision, environment\n\n2. <b>Sensor selection:</b>\n   - Position (encoders, resolvers, LVDTs)\n   - Velocity (tachometers, differentiated position)\n   - Force/torque (load cells, strain gauges)\n   - Considerations: resolution, accuracy, bandwidth, environmental conditions\n\n3. <b>Digital implementation:</b>\n   - Sampling rate: Typically 10-20× system bandwidth\n   - Discrete approximations of continuous controllers\n   - Anti-aliasing filters for sensor signals\n   - Computational requirements for real-time control\n\nEffective control system design requires thorough understanding of both the physical system dynamics and control theory principles to achieve desired performance specifications.",
                },
                
                "controls": {
                    "pid controller": "PID (Proportional-Integral-Derivative) controllers are the most widely used feedback controllers in industrial applications. They calculate control action based on the error between desired setpoint and measured process variable.\n\n<b>PID controller equation:</b>\nu(t) = Kp·e(t) + Ki∫e(t)dt + Kd·de(t)/dt\n\nWhere:\n- u(t) = control signal\n- e(t) = error (setpoint - measured value)\n- Kp = proportional gain\n- Ki = integral gain (often expressed as Kp/Ti)\n- Kd = derivative gain (often expressed as Kp·Td)\n\n<b>Effect of each term:</b>\n\n1. <b>Proportional (P):</b>\n   - Produces output proportional to current error\n   - Higher Kp: Faster response, but may cause oscillation/instability\n   - Lower Kp: Stabler but sluggish response\n   - P-only control typically results in steady-state error for processes with no inherent integration\n\n2. <b>Integral (I):</b>\n   - Produces output based on accumulated error over time\n   - Eliminates steady-state error\n   - Higher Ki: Faster elimination of steady-state error but more overshoot\n   - Lower Ki: Less overshoot but slower error correction\n   - Can cause integral windup when actuator saturates\n\n3. <b>Derivative (D):</b>\n   - Produces output based on rate of error change\n   - Improves stability and reduces overshoot\n   - Higher Kd: More damping effect, but amplifies noise\n   - Lower Kd: Less sensitivity to noise but less damping\n   - Often omitted (PI controller) in noisy environments\n\n<b>Controller tuning methods:</b>\n\n1. <b>Ziegler-Nichols:</b>\n   - Ultimate gain method: Increase Kp until sustained oscillations occur\n   - Step response method: Based on process reaction curve\n   - Provides starting point but typically requires fine-tuning\n\n2. <b>Cohen-Coon:</b>\n   - Based on process reaction curve (step response)\n   - Better for processes with significant dead time\n\n3. <b>Relay auto-tuning:</b>\n   - Uses limit cycle oscillations under relay feedback\n   - Can be performed automatically by modern controllers\n\n4. <b>Optimization techniques:</b>\n   - Minimize performance indices (IAE, ISE, ITAE)\n   - Genetic algorithms, particle swarm optimization\n\n<b>Common PID variations:</b>\n\n1. <b>PI controller:</b> When derivative action is not needed or causes problems\n\n2. <b>PD controller:</b> When integral action causes instability (rarely used alone)\n\n3. <b>Anti-windup schemes:</b> Prevent integral term accumulation during actuator saturation\n\n4. <b>Cascaded PID:</b> Inner loop controls fast dynamics, outer loop controls primary variable\n\n5. <b>Gain scheduling:</b> PID parameters change based on operating conditions\n\n<b>Implementation considerations:</b>\n\n1. <b>Discretization for digital implementation:</b>\n   - Proportional: Kp·e(k)\n   - Integral: I(k) = I(k-1) + Ki·e(k)·Ts\n   - Derivative: Kd·[e(k) - e(k-1)]/Ts  (often with filtering)\n   - Sampling time (Ts) should be 10-20 times faster than system response\n\n2. <b>Derivative filtering:</b> Low-pass filter to reduce noise amplification\n\n3. <b>Setpoint weighting:</b> Reduces overshoot by applying proportional action only to a fraction of setpoint changes\n\nPID controllers remain dominant in industry due to their simplicity, reliability, and effectiveness for a wide range of applications from temperature control to motion systems.",
                    
                    "feedback control": "Feedback control is a fundamental concept in control engineering where the output of a system is measured and compared to a desired reference, with the difference (error) used to adjust the control action. This approach is essential for maintaining desired performance despite uncertainties and disturbances.\n\n<b>Fundamental components of feedback control systems:</b>\n\n1. <b>Plant/Process:</b> The system to be controlled\n   - Characterized by transfer function G(s) or state-space model\n   - May include nonlinearities, time delays, and unmeasured dynamics\n\n2. <b>Sensor/Feedback element:</b> Measures output variable\n   - Characterized by transfer function H(s)\n   - Introduces measurement noise and sometimes dynamics\n\n3. <b>Controller:</b> Calculates control action based on error\n   - Common types: PID, state feedback, adaptive controllers\n   - Characterized by transfer function C(s) or control law\n\n4. <b>Actuator:</b> Converts controller signal to physical input\n   - Subject to limitations (saturation, rate limits, deadband)\n   - May introduce significant dynamics\n\n<b>Closed-loop transfer function:</b>\nT(s) = G(s)C(s)/[1 + G(s)C(s)H(s)]\n\n<b>Key system properties:</b>\n\n1. <b>Stability:</b>\n   - Determined by closed-loop system poles\n   - Stable if all poles have negative real parts\n   - Analyzed using Routh-Hurwitz criterion, root locus, or Nyquist criterion\n\n2. <b>Steady-state performance:</b>\n   - Steady-state error = lim[t→∞] e(t)\n   - System type determines error for specific input types\n   - Type 0: Constant error for step input\n   - Type 1: Zero error for step, constant error for ramp\n   - Type 2: Zero error for step and ramp, constant error for parabolic input\n\n3. <b>Transient response:</b>\n   - Rise time: Time to first reach target value\n   - Settling time: Time to remain within ±2% of final value\n   - Overshoot: Maximum excursion beyond final value\n   - Controlled by dominant poles (damping ratio and natural frequency)\n\n<b>Frequency domain analysis:</b>\n\n1. <b>Bode plot:</b> Magnitude and phase vs. frequency\n   - Gain margin: How much gain can increase before instability\n   - Phase margin: How much phase can decrease before instability\n   - Recommended margins: Gain margin > 6dB, Phase margin > 30°\n\n2. <b>Nyquist plot:</b> Maps G(s)H(s) in complex plane as s traverses Nyquist contour\n   - Encirclements of -1 point determine stability\n\n<b>Advanced feedback concepts:</b>\n\n1. <b>Sensitivity functions:</b>\n   - Sensitivity S(s) = 1/[1 + G(s)C(s)H(s)]\n   - Complementary sensitivity T(s) = G(s)C(s)/[1 + G(s)C(s)H(s)]\n   - S(s) + T(s) = 1 (fundamental algebraic constraint)\n   - S(s): Response to disturbances and model uncertainty\n   - T(s): Response to references and measurement noise\n\n2. <b>Robustness:</b>\n   - Ability to maintain performance despite uncertainties\n   - Gain and phase margins provide basic robustness measures\n   - Structured singular value (μ) for more comprehensive analysis\n\n3. <b>Disturbance rejection:</b>\n   - Feedback inherently provides disturbance attenuation\n   - Effectiveness depends on loop gain at disturbance frequencies\n   - Observer-based disturbance estimation can enhance rejection\n\n<b>Practical implementation considerations:</b>\n\n1. <b>Anti-windup protection</b> for integrators during saturation\n\n2. <b>Bumpless transfer</b> between manual and automatic control modes\n\n3. <b>Noise filtering</b> to prevent high-frequency measurement noise from affecting control\n\n4. <b>Sample rate selection</b> for digital implementation (typically 10-20× bandwidth)\n\nFeedback control provides fundamental benefits including disturbance rejection, reduced sensitivity to parameter variations, and improved tracking performance, making it essential in virtually all mechanical engineering control applications."
                }
            }
            
            # Check if the user's question matches any of our expert responses
            lower_user_message = user_message.lower()
            best_expert_match = None
            
            # Find the best domain based on the specialized prompt
            domain = "general"
            for key in self.domain_responses.keys():
                if key in specialized_prompt.lower():
                    domain = key
                    break
            
            # Check if we have expert responses for this domain
            if domain in expert_responses:
                # Check each keyword in the expert responses for this domain
                for keyword, expert_response in expert_responses[domain].items():
                    if keyword in lower_user_message:
                        best_expert_match = expert_response
                        break
            
            # If we found a matching expert response, return it
            if best_expert_match:
                return best_expert_match
                
            # Otherwise, generate a more general response
            response_templates = self.domain_responses.get(domain, self.domain_responses["general"])
            response = random.choice(response_templates)
            
            # Add mentions of user's specific question
            keywords = ["stress", "strain", "heat", "temperature", "pressure", "force", 
                       "motor", "gear", "material", "fluid", "design", "efficiency", 
                       "vibration", "control", "system"]
            
            user_keywords = [kw for kw in keywords if kw.lower() in user_message.lower()]
            
            if user_keywords:
                # Add specific keyword references
                keyword_str = ", ".join(user_keywords)
                response += f"\n\nRegarding your specific question about {keyword_str}, "
                response += "it's important to consider standard engineering principles and methodologies for accurate analysis and problem-solving."
            
            return response
            
        except Exception as e:
            logger.exception(f"Error generating response: {str(e)}")
            return "I encountered an error while processing your request. Please try again."
